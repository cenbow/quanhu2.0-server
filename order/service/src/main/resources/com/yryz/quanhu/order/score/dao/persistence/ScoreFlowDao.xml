<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper
	namespace="com.yryz.quanhu.order.score.dao.persistence.ScoreFlowDao">
	
	
   <sql id="columns">
   	    id as id,
   		cust_id as custId,
		event_code as eventCode,
		new_score as newScore,
		all_score as allScore,
		consume_flag as consumeFlag,
		create_time as createTime,
		update_time as updateTime
	</sql>
	

	<!-- 新增积分流水 -->
	<insert id="save" keyProperty="id" keyColumn="id"
		useGeneratedKeys="true" parameterType="com.yryz.quanhu.score.entity.ScoreFlow">
		INSERT INTO score_flow(
		cust_id,
		event_code,
		new_score,
		all_score,
		consume_flag,
		create_time,
		update_time
		)
		VALUES (
		#{custId},
		#{eventCode},
		#{newScore},
		#{allScore},
		#{consumeFlag},
		#{createTime},
		#{updateTime}
		)
	</insert>

	<!-- 获取用户积分流水列表 -->
	<select id="getAll" resultType="com.yryz.quanhu.score.entity.ScoreFlow">
		select <include refid="columns" /> from score_flow where
		cust_id = #{custId}
	</select>

	<select id="getPage" resultType="com.yryz.quanhu.score.entity.ScoreFlow">
		select  a.id as id,
   		a.cust_id as custId,
		a.event_code as eventCode,
		a.new_score as newScore,
		a.all_score as allScore,
		a.consume_flag as consumeFlag,
		a.create_time as createTime,
		a.update_time as updateTime , b.event_name as  eventName  from (
		select <include refid="columns" /> from score_flow where cust_id = #{sfq.custId}
		<if test="consumeFlag != -1">
			and consume_flag = #{consumeFlag}
		</if>
		<if test="sfq.eventCode != null">
			and event_code = #{sfq.eventCode}
		</if>
		<if test="sfq.startTime != null">
			and create_time &gt;= #{sfq.startTime}
		</if>
		<if test="sfq.endTime != null">
			and create_time &lt;= #{sfq.endTime}
		</if>
		) a left join event_sys b on a.event_code = b.event_code
		order by id desc limit #{limit} offset #{start}
	</select>

	<!-- 更新积分流水记录 -->
	<update id="update" parameterType="com.yryz.quanhu.score.entity.ScoreFlow">
		UPDATE score_flow
		<trim prefix="set" prefixOverrides=",">
			<if test="newScore != null">
				new_score = #{newScore},
			</if>
			<if test="allScore != null">
				all_score = #{allScore},
			</if>
			update_time = #{updateTime}
		</trim>
		where cust_id = #{custId} and event_code=#{eventCode}
	</update>

</mapper>